function getMouseListFromURL(t){return t?(t=decodeURI(t[1]),t.split("/").join("\n")):[]}function csvToArray(t,o){o=",";for(var n=new RegExp("(\\"+o+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+o+"\\r\\n]*))","gi"),a=[[]],e=n.exec(t);e;){var r=e[1];r.length&&r!=o&&a.push([]);var i;i=e[2]?e[2].replace(new RegExp('""',"g"),'"'):e[3],a[a.length-1].push(i),e=n.exec(t)}return a}function processPopulationData(t){for(var o in t){var n=t[o],a=parseFloat(n[4]);if(a>0){var e=n[5].capitalise(),r=n[0];"-"!==n[1]&&(r+=" - "+n[1]);var i=n[2],s="-"!==n[3]?n[3]:"";void 0===populationData[e]&&(populationData[e]=[]),void 0===populationData[e][r]&&(populationData[e][r]=[]),void 0===populationData[e][r][i]&&(populationData[e][r][i]=[]),populationData[e][r][i][s]=a}}loadMouseDropdown()}function loadMouseDropdown(){var t=[];for(var o in populationData)t.push(o),t.push(o.toLowerCase());$("#map").asuggest(t)}function amendMouseName(t){return t=t.capitalise().trim(),t.indexOf(" Mouse")>=0&&(t=t.slice(0,t.indexOf(" Mouse"))),t}function processMap(t){var o=t.split("\n").map(amendMouseName).filter(function(t){return t.length>0}).sort();o=jQuery.unique(o);for(var n=[],a=[],e=[],r=0;r<o.length;r++){var i=o[r];if(void 0===populationData[i])e.push(i);else{var s=[];for(var c in populationData[i])for(var u in populationData[i][c])for(var p in populationData[i][c][u]){var l=c;""!==u&&(l+="#"+u),""!==p&&(l+="#"+p);var d=populationData[i][c][u][p],h={name:i,rate:d};void 0===a[l]?a[l]={location:c,cheese:u,charm:p,totalRate:d,mice:[h]}:(a[l].totalRate+=d,a[l].mice.push(h)),s[l]=d}n.push({name:i,locations:sortMouseLocations(s)})}}printUnknownMice(e),printBestLocations(sortBestLocations(a)),printMouseLocations(n),$("#mousecount").text(o.length-e.length+" mice")}function sortBestLocations(t){var o=[];for(var n in t)o.push(t[n]);return o.sort(function(t,o){return o.totalRate-t.totalRate}),o}function sortMouseLocations(t){var o=[];for(var n in t)o.push([n,t[n]]);return o.sort(function(t,o){return o[1]-t[1]}),o}function printUnknownMice(t){t.length>0?($("#unknownmice").html(t.reduce(function(t,o){return t+"<p>"+o+"</p>"},"")),$("#unknownmicecontainer").show()):($("#unknownmice").html(""),$("#unknownmicecontainer").hide())}function printMouseLocations(t){var o="";t.sort(function(t,o){return o.locations[0][1]-t.locations[0][1]});for(var n in t){var a=t[n];o+='<tr><td rowspan="2" class="mousename">'+a.name+"</td>";for(var e="<tr>",r=a.locations.length>10?10:a.locations.length,i=0;i<r;i++){var s=a.locations[i][0].split("#");o+='<td class="text"><p><strong>'+s[0]+"</strong></p><p>"+s.slice(1).map(strikethrough).join("</p><p>")+"</p></td>",e+='<td class="rate">'+a.locations[i][1].toFixed(2)+"%</td>"}a.locations.length>10?(o+='<td class="text">('+(a.locations.length-10)+" more)</td>",e+='<td class="rate"></td>'):o+='<td class="padding" rowspan="2" colspan="'+(11-a.locations.length)+'"></td>',o+="</tr>",e+="</tr>",o+=e}$("#mouselist tbody").html(o),$("#mouselistcontainer").toggle(o.length>0)}function strikethrough(t){return t.toLowerCase().indexOf("not")>-1?t.replace(/not (.*)/i,"<strike>$1</strike>"):t}function printBestLocations(t){var o="";o=t.reduce(function(t,o){return t+'<tr><td data-value="'+o.totalRate.toFixed(2)+'"><p><strong>'+o.location+"</strong> ("+o.totalRate.toFixed(2)+"%)</p>"+(o.cheese.length>0?"<p>"+strikethrough(o.cheese)+"</p>":"")+(o.charm.length>0?"<p>"+strikethrough(o.charm)+"</p>":"")+'</td><td data-value="'+o.mice.length+'">'+o.mice.sort(function(t,o){return o.rate-t.rate}).reduce(function(t,o){return t+"<p>"+o.name+" ("+o.rate.toFixed(2)+"%)</p>"},"")+"</td></tr>"},""),$("#bestlocations tbody").html(o),$("#bestlocationscontainer").toggle(o.length>0)}var populationData=[];$(document).ready(function(){var t=getMouseListFromURL(window.location.search.match(/mice=([^&]*)/));if(0===t.length){var o=$.cookie("mouselist");void 0!==o&&$("#map").val($.cookie("mouselist"))}else $("#map").val(t);var n=new XMLHttpRequest;n.open("get","http://olf.github.io/mhmapsolver/data/attractionrates.csv",!0),n.onreadystatechange=function(){if(4==n.readyState){var t=csvToArray(n.responseText);processPopulationData(t),processMap($("#map").val())}},n.send(),$("#map").keyup(function(){var t=$("#map").val();processMap(t),$.cookie("mouselist",t,{expires:14})})}),String.prototype.capitalise=function(){return this.replace(/(?:^|\s)\S/g,function(t){return t.toUpperCase()})};