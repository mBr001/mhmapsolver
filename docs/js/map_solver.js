function getMouseListFromURL(t){return t?(t=decodeURI(t[1])).split("/").join("\n"):[]}function csvToArray(t,o){o=",";for(var n=new RegExp("(\\"+o+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+o+"\\r\\n]*))","gi"),e=[[]],a=n.exec(t);a;){var r=a[1];r.length&&r!=o&&e.push([]);var i;i=a[2]?a[2].replace(new RegExp('""',"g"),'"'):a[3],e[e.length-1].push(i),a=n.exec(t)}return e}function processPopulationData(t){for(var o in t){var n=t[o],e=parseFloat(n[4]);if(e>0){var a=n[5].capitalise(),r=n[0];n[1].length>1&&(r+=" - "+n[1]);var i=n[2],s=n[3].length>1?n[3]:"";void 0===populationData[a]&&(populationData[a]=[]),void 0===populationData[a][r]&&(populationData[a][r]=[]),void 0===populationData[a][r][i]&&(populationData[a][r][i]=[]),populationData[a][r][i][s]=e}}loadMouseDropdown()}function loadMouseDropdown(){var t=[];for(var o in populationData)t.push(o),t.push(o.toLowerCase());$("#map").asuggest(t)}function amendMouseName(t){return(t=t.capitalise().trim()).indexOf(" Mouse")>=0&&(t=t.slice(0,t.indexOf(" Mouse"))),t}function processMap(t){var o=t.split("\n").map(amendMouseName).filter(function(t){return t.length>0}).sort();o=jQuery.unique(o);for(var n=[],e=[],a=[],r=0;r<o.length;r++){var i=o[r];if(void 0===populationData[i])a.push(i);else{var s=[];for(var c in populationData[i])for(var u in populationData[i][c])for(var p in populationData[i][c][u]){var l=c;""!==u&&(l+="#"+u),""!==p&&(l+="#"+p);var h=populationData[i][c][u][p],d={name:i,rate:h};void 0===e[l]?e[l]={location:c,cheese:u,charm:p,totalRate:h,mice:[d]}:(e[l].totalRate+=h,e[l].mice.push(d)),s[l]=h}n.push({name:i,locations:sortMouseLocations(s)})}}printUnknownMice(a),printBestLocations(sortBestLocations(e)),printMouseLocations(n),$("#mousecount").text(o.length-a.length+" mice")}function sortBestLocations(t){var o=[];for(var n in t)o.push(t[n]);return o.sort(function(t,o){return o.totalRate-t.totalRate}),o}function sortMouseLocations(t){var o=[];for(var n in t)o.push([n,t[n]]);return o.sort(function(t,o){return o[1]-t[1]}),o}function printUnknownMice(t){t.length>0?($("#unknownmice").html(t.reduce(function(t,o){return t+"<p>"+o+"</p>"},"")),$("#unknownmicecontainer").show()):($("#unknownmice").html(""),$("#unknownmicecontainer").hide())}function printMouseLocations(t){var o="";t.sort(function(t,o){return o.locations[0][1]-t.locations[0][1]});for(var n in t){var e=t[n];o+='<tr><td rowspan="2" class="mousename">'+e.name+"</td>";for(var a="<tr>",r=e.locations.length>10?10:e.locations.length,i=0;i<r;i++){var s=e.locations[i][0].split("#");o+='<td class="text"><p><strong>'+s[0]+"</strong></p><p>"+s.slice(1).map(strikethrough).join("</p><p>")+"</p></td>",a+='<td class="rate">'+e.locations[i][1].toFixed(2)+"%</td>"}e.locations.length>10?(o+='<td class="text">('+(e.locations.length-10)+" more)</td>",a+='<td class="rate"></td>'):o+='<td class="padding" rowspan="2" colspan="'+(11-e.locations.length)+'"></td>',o+="</tr>",o+=a+="</tr>"}$("#mouselist tbody").html(o),$("#mouselistcontainer").toggle(o.length>0)}function strikethrough(t){return t.toLowerCase().indexOf("not")>-1?t.replace(/not (.*)/i,"<strike>$1</strike>"):t}function printBestLocations(t){var o="";o=t.reduce(function(t,o){return t+'<tr><td data-value="'+o.totalRate.toFixed(2)+'"><p><strong>'+o.location+"</strong> ("+o.totalRate.toFixed(2)+"%)</p>"+(o.cheese.length>0?"<p>"+strikethrough(o.cheese)+"</p>":"")+(o.charm.length>0?"<p>"+strikethrough(o.charm)+"</p>":"")+'</td><td data-value="'+o.mice.length+'">'+o.mice.sort(function(t,o){return o.rate-t.rate}).reduce(function(t,o){return t+"<p>"+o.name+" ("+o.rate.toFixed(2)+"%)</p>"},"")+"</td></tr>"},""),$("#bestlocations tbody").html(o),$("#bestlocationscontainer").toggle(o.length>0)}var populationData=[];$(document).ready(function(){var t=getMouseListFromURL(window.location.search.match(/mice=([^&]*)/));0===t.length?void 0!==$.cookie("mouselist")&&$("#map").val($.cookie("mouselist")):$("#map").val(t);var o=new XMLHttpRequest;o.open("get","https://olf.github.io/mhmapsolver/data/attractionrates.csv",!0),o.onreadystatechange=function(){4==o.readyState&&(processPopulationData(csvToArray(o.responseText)),processMap($("#map").val()))},o.send(),$("#map").keyup(function(){var t=$("#map").val();processMap(t),$.cookie("mouselist",t,{expires:14})})}),String.prototype.capitalise=function(){return this.replace(/(?:^|\s)\S/g,function(t){return t.toUpperCase()})};