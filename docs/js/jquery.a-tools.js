var caretPositionAmp;jQuery.fn.extend({getSelection:function(){var e,t,n,o=this.jquery?this[0]:this,r=0;if(o.onmousedown=function(){document.selection&&"number"!=typeof o.selectionStart?document.selection.empty():window.getSelection().removeAllRanges()},document.selection){var a,i,c=document.selection.createRange(),s=0,l=0,u=0;if(null!=o.value.match(/\n/g)&&(r=o.value.match(/\n/g).length),c.text){if(n=c.text,"number"==typeof o.selectionStart){if(e=o.selectionStart,t=o.selectionEnd,e==t)return{start:e,end:t,text:c.text,length:t-e}}else{var m,h;if(a=o.createTextRange(),i=a.duplicate(),m=a.text,a.moveToBookmark(c.getBookmark()),h=a.text,i.setEndPoint("EndToStart",a),m==h&&m!=c.text)return this;e=i.text.length,t=i.text.length+c.text.length}if(r>0)for(g=0;g<=r;g++)if(-1!=(f=o.value.indexOf("\n",l))&&f<e)l=f+1,u=++s;else if(-1!=f&&f>=e&&f<=t){if(f==e+1){s--,u--,l=f+1;continue}l=f+1,u++}else g=r;return 1==c.text.indexOf("\n",0)&&(u+=2),e-=s,t-=u,{start:e,end:t,text:c.text,length:t-e}}if(o.focus(),"number"==typeof o.selectionStart?e=o.selectionStart:(c=document.selection.createRange(),i=(a=o.createTextRange()).duplicate(),a.moveToBookmark(c.getBookmark()),i.setEndPoint("EndToStart",a),e=i.text.length),r>0)for(var g=0;g<=r;g++){var f=o.value.indexOf("\n",l);-1!=f&&f<e?(l=f+1,s++):g=r}return e-=s,{start:e,end:e,text:c.text,length:0}}return"number"==typeof o.selectionStart?(e=o.selectionStart,t=o.selectionEnd,n=o.value.substring(o.selectionStart,o.selectionEnd),{start:e,end:t,text:n,length:t-e}):{start:void 0,end:void 0,text:void 0,length:void 0}},replaceSelection:function(e){var t,n,o,r,a=this.jquery?this[0]:this,i=0,c=0,s=void 0==a.scrollTop?0:a.scrollTop;if(document.selection&&"number"!=typeof a.selectionStart){var l=document.selection.createRange();if("number"!=typeof a.selectionStart){var u,m;if(r=a.createTextRange(),o=r.duplicate(),u=r.text,r.moveToBookmark(l.getBookmark()),m=r.text,o.setEndPoint("EndToStart",r),u==m&&u!=l.text)return this}if(l.text){if(part=l.text,null!=a.value.match(/\n/g)&&(c=a.value.match(/\n/g).length),t=o.text.length,c>0)for(var h=0;h<=c;h++){var g=a.value.indexOf("\n",i);-1!=g&&g<t?(i=g+1,0):h=c}l.text=e,caretPositionAmp=o.text.length+e.length,r.move("character",caretPositionAmp),document.selection.empty(),a.blur()}return this}return"number"==typeof a.selectionStart&&a.selectionStart!=a.selectionEnd?(t=a.selectionStart,n=a.selectionEnd,a.value=a.value.substr(0,t)+e+a.value.substr(n),i=t+e.length,a.setSelectionRange(i,i),a.scrollTop=s,this):this},setSelection:function(e,t){e=parseInt(e),t=parseInt(t);var n=this.jquery?this[0]:this;if(n.focus(),"number"!=typeof n.selectionStart&&(re=n.createTextRange(),re.text.length<t&&(t=re.text.length+1)),t<e)return this;if(document.selection){var o=0,r=0,a=0,i=0;if("number"!=typeof n.selectionStart)return re.collapse(!0),re.moveEnd("character",t),re.moveStart("character",e),re.select(),this;if("number"==typeof n.selectionStart){if(null!=n.value.match(/\n/g)&&(o=n.value.match(/\n/g).length),o>0)for(var c=0;c<=o;c++){var s=n.value.indexOf("\n",a);if(-1!=s&&s<e)a=s+1,i=++r;else if(-1!=s&&s>=e&&s<=t){if(s==e+1){r--,i--,a=s+1;continue}a=s+1,i++}else c=o}return e+=r,t+=i,n.selectionStart=e,n.selectionEnd=t,this}return this}return n.selectionStart?(n.focus(),n.selectionStart=e,n.selectionEnd=t,this):void 0},insertAtCaretPos:function(e){var t,n,o,r,a,i,c,s=this.jquery?this[0]:this,l=0,u=0,m=void 0==s.scrollTop?0:s.scrollTop;if(s.focus(),document.selection&&"number"!=typeof s.selectionStart&&(null!=s.value.match(/\n/g)&&(u=s.value.match(/\n/g).length),c=parseInt(caretPositionAmp),u>0))for(var h=0;h<=u;h++){var g=s.value.indexOf("\n",o);-1!=g&&g<=c&&(o=g+1,c-=1,l++)}return caretPositionAmp=parseInt(caretPositionAmp),s.onmouseup=function(){document.selection&&"number"!=typeof s.selectionStart&&(s.focus(),r=document.selection.createRange(),a=s.createTextRange(),i=a.duplicate(),a.moveToBookmark(r.getBookmark()),i.setEndPoint("EndToStart",a),caretPositionAmp=i.text.length)},document.selection&&"number"!=typeof s.selectionStart?0!=(r=document.selection.createRange()).text.length?this:(a=s.createTextRange(),textLength=a.text.length,i=a.duplicate(),a.moveToBookmark(r.getBookmark()),i.setEndPoint("EndToStart",a),t=i.text.length,caretPositionAmp>0&&0==t?(l=caretPositionAmp-l,a.move("character",l),a.select(),r=document.selection.createRange(),caretPositionAmp+=e.length):caretPositionAmp>=0||0!=textLength?caretPositionAmp>=0||0!=t?!(caretPositionAmp>=0)&&t>0?(a.move("character",0),document.selection.empty(),a.select(),r=document.selection.createRange(),caretPositionAmp=t+e.length):caretPositionAmp>=0&&caretPositionAmp==textLength?(0!=textLength?(a.move("character",textLength),a.select()):a.move("character",0),r=document.selection.createRange(),caretPositionAmp=e.length+textLength):caretPositionAmp>=0&&0!=t&&caretPositionAmp>=t?(l=caretPositionAmp-t,a.move("character",l),document.selection.empty(),a.select(),r=document.selection.createRange(),caretPositionAmp+=e.length):caretPositionAmp>=0&&0!=t&&caretPositionAmp<t?(a.move("character",0),document.selection.empty(),a.select(),r=document.selection.createRange(),caretPositionAmp+=e.length):(document.selection.empty(),a.select(),r=document.selection.createRange(),caretPositionAmp+=e.length):(a.move("character",textLength),a.select(),r=document.selection.createRange(),caretPositionAmp=e.length+textLength):(r=document.selection.createRange(),caretPositionAmp=e.length+textLength),r.text=e,s.focus(),this):"number"==typeof s.selectionStart&&s.selectionStart==s.selectionEnd?(o=s.selectionStart+e.length,t=s.selectionStart,n=s.selectionEnd,s.value=s.value.substr(0,t)+e+s.value.substr(n),s.setSelectionRange(o,o),s.scrollTop=m,this):this},setCaretPos:function(e){var t,n,o,r=this.jquery?this[0]:this,a=0,i=0;if(r.focus(),0==parseInt(e))return this;if(parseInt(e)>0){if(e=parseInt(e)-1,document.selection&&"number"==typeof r.selectionStart&&r.selectionStart==r.selectionEnd&&(null!=r.value.match(/\n/g)&&(a=r.value.match(/\n/g).length),a>0))for(c=0;c<=a;c++)-1!=(o=r.value.indexOf("\n",n))&&o<=e&&(n=o+1,e=parseInt(e)+1)}else{if(!(parseInt(e)<0))return this;if(e=parseInt(e)+1,document.selection&&"number"!=typeof r.selectionStart){if(e=r.value.length+parseInt(e),null!=r.value.match(/\n/g)&&(a=r.value.match(/\n/g).length),a>0){for(c=0;c<=a;c++)-1!=(o=r.value.indexOf("\n",n))&&o<=e&&(n=o+1,e=parseInt(e)-1,i+=1);e=e+i-a}}else if(document.selection&&"number"==typeof r.selectionStart){if(e=r.value.length+parseInt(e),null!=r.value.match(/\n/g)&&(a=r.value.match(/\n/g).length),a>0){e=parseInt(e)-a;for(var c=0;c<=a;c++)-1!=(o=r.value.indexOf("\n",n))&&o<=e&&(n=o+1,e=parseInt(e)+1,i+=1)}}else e=r.value.length+parseInt(e)}return document.selection&&"number"!=typeof r.selectionStart?0!=document.selection.createRange().text?this:((t=r.createTextRange()).collapse(!0),t.moveEnd("character",e),t.moveStart("character",e),t.select(),caretPositionAmp=e,this):"number"==typeof r.selectionStart&&r.selectionStart==r.selectionEnd?(r.setSelectionRange(e,e),this):this},countCharacters:function(e){var t=this.jquery?this[0]:this;return null!=t.value.match(/\r/g)?t.value.length-t.value.match(/\r/g).length:t.value.length},setMaxLength:function(e,t){return this.each(function(){var n,o,r=this.jquery?this[0]:this,a=r.type;if(parseInt(e)<0&&(e=1e8),"text"==a&&(r.maxLength=e),"textarea"!=a&&"text"!=a)return this;r.onkeypress=function(a){var i=r.value.match(/\r/g);o=e,null!=i&&(o=parseInt(o)+i.length);var c=a||event,s=c.keyCode;if(n=document.selection?document.selection.createRange().text.length>0:r.selectionStart!=r.selectionEnd,r.value.length>=o&&(s>47||32==s||0==s||13==s)&&!c.ctrlKey&&!c.altKey&&!n)return r.value=r.value.substring(0,o),"function"==typeof t&&t(),!1},r.onkeyup=function(){var n=r.value.match(/\r/g),a=0,i=0;if(o=e,null!=n){for(var c=0;c<=n.length;c++)r.value.indexOf("\n",i)<=parseInt(e)&&(a++,i=r.value.indexOf("\n",i)+1);o=parseInt(e)+a}if(r.value.length>o)return r.value=r.value.substring(0,o),"function"==typeof t&&t(),this}}),this}});